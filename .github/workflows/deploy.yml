name: Publish NPM

on:
  workflow_call:
    inputs:
      target-env:
        required: true
        type: string
  workflow_dispatch:
    inputs:
      target-env:
        type: choice
        description: 'Target environment'
        required: true
        options: [development, staging, production]
      dry_run:
        description: 'Dry run (no publish)'
        required: false
        type: boolean
        default: false
      node_version:
        description: 'Node version'
        required: false
        default: '20'

env:
  NODE_VERSION: ${{ inputs.node_version || '20' }}

jobs:
  publish:
    name: Publish to NPM
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ensure tags are available

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install deps
        run: npm ci

      - name: Determine dist-tag (tag-derived with target-env override)
        id: dist
        shell: bash
        run: |
          set -euo pipefail

          # default derived from latest tag
          git fetch --tags --force || true
          LATEST_TAG="$(git tag --list | sort -Vr | head -n1)"
          if [ -z "$LATEST_TAG" ] && [ -n "${GITHUB_REF_NAME:-}" ]; then
            LATEST_TAG="$GITHUB_REF_NAME"
          fi

          derive_from_tag () {
            local tag="$1"
            tag_lc="$(echo "$tag" | tr '[:upper:]' '[:lower:]')"
            if echo "$tag_lc" | grep -q -- "-beta"; then
              echo "beta"
              return
            fi
            if echo "$tag_lc" | grep -Eq -- "-(dev|alpha|next|canary|rc)"; then
              echo "next"
              return
            fi
            echo "latest"
          }

          DERIVED="latest"
          if [ -n "$LATEST_TAG" ]; then
            DERIVED="$(derive_from_tag "$LATEST_TAG")"
          fi

          # Override with target-env if provided
          TARGET_ENV="${{ inputs.target-env || '' }}"
          if [ -n "$TARGET_ENV" ]; then
            case "$TARGET_ENV" in
              development) DIST_TAG="next" ;;
              staging)     DIST_TAG="beta" ;;
              production)  DIST_TAG="latest" ;;
              *)
                echo "Unknown target-env '$TARGET_ENV' — falling back to derived '$DERIVED'."
                DIST_TAG="$DERIVED"
                ;;
            esac
          else
            DIST_TAG="$DERIVED"
          fi

          echo "latest_tag=${LATEST_TAG:-<none>}" >> $GITHUB_OUTPUT
          echo "dist_tag=$DIST_TAG" >> $GITHUB_OUTPUT
          echo "Using dist-tag: $DIST_TAG (latest tag: ${LATEST_TAG:-none}, target-env: ${TARGET_ENV:-none})"

      - name: Show npm pack (dry)
        run: npm pack --dry-run

      - name: Publish
        if: ${{ inputs.dry_run != true }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "Publishing with dist-tag: ${{ steps.dist.outputs.dist_tag }}"
          npm publish --access public --tag "${{ steps.dist.outputs.dist_tag }}" --provenance || \
          npm publish --access public --tag "${{ steps.dist.outputs.dist_tag }}"

      - name: Dry run note
        if: ${{ inputs.dry_run == true }}
        run: echo "Dry run enabled — skipping publish."

      - name: Post-publish info
        run: |
          NAME=$(node -p "require('./package.json').name")
          VERSION=$(node -p "require('./package.json').version")
          echo "Published $NAME@$VERSION with tag: ${{ steps.dist.outputs.dist_tag }}"